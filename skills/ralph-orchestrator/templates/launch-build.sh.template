#!/bin/bash
# Ralph Cockpit — Service windows launcher (Ghostty optional viewer)
# Generated by ralph-orchestrator Step 8
#
# Creates a tmux session with service windows ONLY:
#   Window "services" — Dev server, DB (if configured)
#   Window "quality"  — Test watcher (if configured)
#   Window "monitor"  — Application logs (if configured)
#   Window "shell"    — Free terminal for the user
#
# The Claude Code lead runs in the CURRENT session (not inside tmux).
# This script only creates service windows for cockpit visibility.
#
# Usage: bash .ralph/launch-build.sh
set -euo pipefail

# ─────────────────────────────────────────────────────────────────
# CONFIGURATION
# ─────────────────────────────────────────────────────────────────

PROJECT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
# Session name derived from goal (set in config.sh, default: ralph)
SESSION="${RALPH_SESSION_NAME:-ralph}"

# Source project config for cockpit settings
# shellcheck source=/dev/null
source "$PROJECT_DIR/.ralph/config.sh" 2>/dev/null || true

# Cockpit pane commands (empty = skip that window)
DEV_SERVER="${COCKPIT_DEV_SERVER:-}"
TEST_WATCHER="${COCKPIT_TEST_WATCHER:-}"
LOG_CMD="${COCKPIT_LOGS:-}"
DB_CMD="${COCKPIT_DB:-}"

# ─────────────────────────────────────────────────────────────────
# PREFLIGHT
# ─────────────────────────────────────────────────────────────────

if ! command -v tmux &>/dev/null; then
    echo "ERROR: tmux is required for service windows. Install with: brew install tmux"
    exit 1
fi

# Check if any service is configured
if [[ -z "$DEV_SERVER" && -z "$TEST_WATCHER" && -z "$LOG_CMD" && -z "$DB_CMD" ]]; then
    echo "No COCKPIT_* services configured in .ralph/config.sh. No tmux session needed."
    exit 0
fi

# ─────────────────────────────────────────────────────────────────
# CLEANUP PREVIOUS SESSION
# ─────────────────────────────────────────────────────────────────

tmux kill-session -t "$SESSION" 2>/dev/null || true

# ─────────────────────────────────────────────────────────────────
# BUILD TMUX SESSION (service windows only)
# ─────────────────────────────────────────────────────────────────

SESSION_CREATED=false

# Window: Services — Dev server + DB (only if configured)
if [[ -n "$DEV_SERVER" ]]; then
    if [[ "$SESSION_CREATED" == "false" ]]; then
        tmux new-session -d -s "$SESSION" -n "services" -c "$PROJECT_DIR"
        SESSION_CREATED=true
    else
        tmux new-window -t "$SESSION" -n "services" -c "$PROJECT_DIR"
    fi
    tmux send-keys -t "$SESSION:services" "$DEV_SERVER" Enter

    if [[ -n "$DB_CMD" ]]; then
        tmux split-window -v -t "$SESSION:services" -c "$PROJECT_DIR"
        tmux send-keys -t "$SESSION:services.1" "$DB_CMD" Enter
    fi
elif [[ -n "$DB_CMD" ]]; then
    if [[ "$SESSION_CREATED" == "false" ]]; then
        tmux new-session -d -s "$SESSION" -n "services" -c "$PROJECT_DIR"
        SESSION_CREATED=true
    else
        tmux new-window -t "$SESSION" -n "services" -c "$PROJECT_DIR"
    fi
    tmux send-keys -t "$SESSION:services" "$DB_CMD" Enter
fi

# Window: Quality — Test watcher (only if configured)
if [[ -n "$TEST_WATCHER" ]]; then
    if [[ "$SESSION_CREATED" == "false" ]]; then
        tmux new-session -d -s "$SESSION" -n "quality" -c "$PROJECT_DIR"
        SESSION_CREATED=true
    else
        tmux new-window -t "$SESSION" -n "quality" -c "$PROJECT_DIR"
    fi
    tmux send-keys -t "$SESSION:quality" "$TEST_WATCHER" Enter
fi

# Window: Monitor — Logs (only if configured)
if [[ -n "$LOG_CMD" ]]; then
    if [[ "$SESSION_CREATED" == "false" ]]; then
        tmux new-session -d -s "$SESSION" -n "monitor" -c "$PROJECT_DIR"
        SESSION_CREATED=true
    else
        tmux new-window -t "$SESSION" -n "monitor" -c "$PROJECT_DIR"
    fi
    tmux send-keys -t "$SESSION:monitor" "$LOG_CMD" Enter
fi

# Window: Shell — Free terminal (always, if session exists)
if [[ "$SESSION_CREATED" == "true" ]]; then
    tmux new-window -t "$SESSION" -n "shell" -c "$PROJECT_DIR"
fi

# ─────────────────────────────────────────────────────────────────
# OPEN VIEWER (Ghostty recommended — tmux is the service layer)
# ─────────────────────────────────────────────────────────────────
# Ghostty opens a dedicated window to visualize service output.
# Without it, the service windows run headless in tmux —
# attach manually from an external terminal to observe.

if [[ "$(uname -s)" == "Darwin" ]] && [ -d "/Applications/Ghostty.app" ]; then
    open -na Ghostty.app --args \
        --title="Ralph Services: $(basename "$PROJECT_DIR")" \
        -e "tmux attach -t $SESSION"
else
    echo ""
    echo "══════════════════════════════════════════════════════════"
    echo "  Ralph service windows running in tmux session: $SESSION"
    echo "══════════════════════════════════════════════════════════"
    echo ""
    echo "  To observe service windows, run from an EXTERNAL terminal:"
    echo ""
    echo "    tmux attach -t $SESSION"
    echo ""
    echo "  Windows: Ctrl+B {N} to navigate"
    echo ""
    echo "  TIP: Install Ghostty for automatic viewer:"
    echo "    brew install --cask ghostty"
    echo "══════════════════════════════════════════════════════════"
fi
