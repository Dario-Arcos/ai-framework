#!/bin/bash
# Ralph Cockpit — tmux cockpit launcher (Ghostty optional viewer)
# Generated by ralph-orchestrator Step 8 (Agent Teams variant)
#
# Creates a tmux session with:
#   Window "team"     — Claude Code lead + auto-split teammate panes
#   Window "services" — Dev server, DB (if configured)
#   Window "quality"  — Test watcher (if configured)
#   Window "monitor"  — Application logs (if configured)
#   Window "shell"    — Free terminal for the user
#
# Usage: bash .ralph/launch-build.sh
set -euo pipefail

# ─────────────────────────────────────────────────────────────────
# CONFIGURATION
# ─────────────────────────────────────────────────────────────────

PROJECT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
# Session name derived from goal (set in config.sh, default: ralph)
SESSION="${RALPH_SESSION_NAME:-ralph}"

# Source project config for cockpit settings
# shellcheck source=/dev/null
source "$PROJECT_DIR/.ralph/config.sh" 2>/dev/null || true

# Cockpit pane commands (empty = skip that window)
DEV_SERVER="${COCKPIT_DEV_SERVER:-}"
TEST_WATCHER="${COCKPIT_TEST_WATCHER:-}"
LOG_CMD="${COCKPIT_LOGS:-}"
DB_CMD="${COCKPIT_DB:-}"

# ─────────────────────────────────────────────────────────────────
# PREFLIGHT
# ─────────────────────────────────────────────────────────────────

if ! command -v tmux &>/dev/null; then
    echo "ERROR: tmux is required. Install with: brew install tmux"
    exit 1
fi

if ! command -v claude &>/dev/null; then
    echo "ERROR: claude CLI is required."
    exit 1
fi

# ─────────────────────────────────────────────────────────────────
# CLEANUP PREVIOUS SESSION
# ─────────────────────────────────────────────────────────────────

tmux kill-session -t "$SESSION" 2>/dev/null || true

# ─────────────────────────────────────────────────────────────────
# BUILD TMUX SESSION
# ─────────────────────────────────────────────────────────────────

# Window 0: Team — Claude Code lead with teammate-mode tmux
# Agent Teams auto-creates split panes for each spawned teammate
tmux new-session -d -s "$SESSION" -n "team" -c "$PROJECT_DIR" \
    "claude --teammate-mode tmux"

# Window 1: Services — Dev server + DB (only if configured)
if [[ -n "$DEV_SERVER" ]]; then
    tmux new-window -t "$SESSION" -n "services" -c "$PROJECT_DIR"
    tmux send-keys -t "$SESSION:services" "$DEV_SERVER" Enter

    if [[ -n "$DB_CMD" ]]; then
        tmux split-window -v -t "$SESSION:services" -c "$PROJECT_DIR"
        tmux send-keys -t "$SESSION:services.1" "$DB_CMD" Enter
    fi
fi

# Window 2: Quality — Test watcher (only if configured)
if [[ -n "$TEST_WATCHER" ]]; then
    tmux new-window -t "$SESSION" -n "quality" -c "$PROJECT_DIR"
    tmux send-keys -t "$SESSION:quality" "$TEST_WATCHER" Enter
fi

# Window 3: Monitor — Logs (only if configured)
if [[ -n "$LOG_CMD" ]]; then
    tmux new-window -t "$SESSION" -n "monitor" -c "$PROJECT_DIR"
    tmux send-keys -t "$SESSION:monitor" "$LOG_CMD" Enter
fi

# Window 4: Shell — Free terminal (always)
tmux new-window -t "$SESSION" -n "shell" -c "$PROJECT_DIR"

# ─────────────────────────────────────────────────────────────────
# AUTO-INVOKE RALPH-ORCHESTRATOR
# ─────────────────────────────────────────────────────────────────

# Focus on team window
tmux select-window -t "$SESSION:team"

# Wait for Claude Code to be ready (poll every 2s, timeout 60s)
MAX_WAIT=60
ELAPSED=0
READY=false
while [[ $ELAPSED -lt $MAX_WAIT ]]; do
    PANE_CONTENT=$(tmux capture-pane -p -t "$SESSION:team" 2>/dev/null || true)
    if echo "$PANE_CONTENT" | grep -qE '(^>|Human:)'; then
        READY=true
        break
    fi
    sleep 2
    ELAPSED=$((ELAPSED + 2))
done

if [[ "$READY" == "true" ]]; then
    # State detection will route to Step 8 automatically
    tmux send-keys -t "$SESSION:team" "/ralph-orchestrator" Enter
else
    echo "WARNING: Claude Code did not become ready within ${MAX_WAIT}s."
    echo "Manually invoke /ralph-orchestrator in the team window."
fi

# ─────────────────────────────────────────────────────────────────
# OPEN VIEWER (Ghostty recommended — tmux is the execution layer)
# ─────────────────────────────────────────────────────────────────
# Ghostty opens a dedicated window to visualize and interact with the cockpit.
# Without it, the cockpit runs headless in tmux — agents work fine,
# but you need to manually attach from an external terminal to observe/intervene.

if [[ "$(uname -s)" == "Darwin" ]] && [ -d "/Applications/Ghostty.app" ]; then
    open -na Ghostty.app --args \
        --title="Ralph Cockpit: $(basename "$PROJECT_DIR")" \
        -e "tmux attach -t $SESSION"
else
    echo ""
    echo "══════════════════════════════════════════════════════════"
    echo "  Ralph cockpit running in tmux session: $SESSION"
    echo "══════════════════════════════════════════════════════════"
    echo ""
    echo "  Agents are working. To observe the cockpit, run from"
    echo "  an EXTERNAL terminal (not this one):"
    echo ""
    echo "    tmux attach -t $SESSION"
    echo ""
    echo "  Windows: Ctrl+B {N}"
    echo "    0=team  1=services  2=quality  3=monitor  last=shell"
    echo ""
    echo "  TIP: Install Ghostty for automatic cockpit viewer:"
    echo "    brew install --cask ghostty"
    echo "══════════════════════════════════════════════════════════"
fi
