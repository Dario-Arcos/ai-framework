#!/bin/bash
# Ralph Cockpit — Ghostty + tmux launcher for Agent Teams execution
# Generated by ralph-orchestrator Step 8 (Agent Teams variant)
#
# Creates a tmux session with:
#   Window "team"     — Claude Code lead + auto-split teammate panes
#   Window "services" — Dev server, DB (if configured)
#   Window "quality"  — Test watcher (if configured)
#   Window "monitor"  — Application logs (if configured)
#   Window "shell"    — Free terminal for the user
#
# Usage: bash .ralph/launch-build.sh
set -euo pipefail

# ─────────────────────────────────────────────────────────────────
# CONFIGURATION
# ─────────────────────────────────────────────────────────────────

PROJECT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
SESSION="ralph"

# Source project config for cockpit settings
# shellcheck source=/dev/null
source "$PROJECT_DIR/.ralph/config.sh" 2>/dev/null || true

# Cockpit pane commands (empty = skip that window)
DEV_SERVER="${COCKPIT_DEV_SERVER:-}"
TEST_WATCHER="${COCKPIT_TEST_WATCHER:-}"
LOG_CMD="${COCKPIT_LOGS:-}"
DB_CMD="${COCKPIT_DB:-}"

# ─────────────────────────────────────────────────────────────────
# PREFLIGHT
# ─────────────────────────────────────────────────────────────────

if ! command -v tmux &>/dev/null; then
    echo "ERROR: tmux is required. Install with: brew install tmux"
    exit 1
fi

if ! command -v claude &>/dev/null; then
    echo "ERROR: claude CLI is required."
    exit 1
fi

# ─────────────────────────────────────────────────────────────────
# CLEANUP PREVIOUS SESSION
# ─────────────────────────────────────────────────────────────────

tmux kill-session -t "$SESSION" 2>/dev/null || true

# ─────────────────────────────────────────────────────────────────
# BUILD TMUX SESSION
# ─────────────────────────────────────────────────────────────────

# Window 0: Team — Claude Code lead with teammate-mode tmux
# Agent Teams auto-creates split panes for each spawned teammate
tmux new-session -d -s "$SESSION" -n "team" -c "$PROJECT_DIR" \
    "claude --teammate-mode tmux"

# Window 1: Services — Dev server + DB (only if configured)
if [[ -n "$DEV_SERVER" ]]; then
    tmux new-window -t "$SESSION" -n "services" -c "$PROJECT_DIR"
    tmux send-keys -t "$SESSION:services" "$DEV_SERVER" Enter

    if [[ -n "$DB_CMD" ]]; then
        tmux split-window -v -t "$SESSION:services" -c "$PROJECT_DIR"
        tmux send-keys -t "$SESSION:services.1" "$DB_CMD" Enter
    fi
fi

# Window 2: Quality — Test watcher (only if configured)
if [[ -n "$TEST_WATCHER" ]]; then
    tmux new-window -t "$SESSION" -n "quality" -c "$PROJECT_DIR"
    tmux send-keys -t "$SESSION:quality" "$TEST_WATCHER" Enter
fi

# Window 3: Monitor — Logs (only if configured)
if [[ -n "$LOG_CMD" ]]; then
    tmux new-window -t "$SESSION" -n "monitor" -c "$PROJECT_DIR"
    tmux send-keys -t "$SESSION:monitor" "$LOG_CMD" Enter
fi

# Window 4: Shell — Free terminal (always)
tmux new-window -t "$SESSION" -n "shell" -c "$PROJECT_DIR"

# ─────────────────────────────────────────────────────────────────
# AUTO-INVOKE RALPH-ORCHESTRATOR
# ─────────────────────────────────────────────────────────────────

# Focus on team window
tmux select-window -t "$SESSION:team"

# Wait for Claude Code to initialize
sleep 4

# State detection will route to Step 8 automatically
tmux send-keys -t "$SESSION:team" "/ralph-orchestrator" Enter

# ─────────────────────────────────────────────────────────────────
# OPEN GHOSTTY
# ─────────────────────────────────────────────────────────────────

# macOS: open Ghostty attached to the tmux session
if [[ "$(uname -s)" == "Darwin" ]]; then
    open -na Ghostty.app --args \
        --title="Ralph Cockpit: $(basename "$PROJECT_DIR")" \
        -e "tmux attach -t $SESSION"
else
    # Linux/other: attach directly (assumes running in a terminal)
    tmux attach -t "$SESSION"
fi
