# State Files Reference

## Overview

This reference defines the state files used by Ralph for persistent state management across Agent Teams execution. Understanding these files is essential for debugging and maintaining context continuity.

---

## File Overview

**Constraints:**
- You MUST understand file lifecycle because incorrect updates corrupt state
- You MUST NOT modify state files during execution because teammates and hooks own state during cockpit sessions
- You SHOULD read state files for debugging because they reveal execution behavior

| File | Purpose | Lifecycle |
|------|---------|-----------|
| `.ralph/config.sh` | Project configuration | Project lifetime |
| `.ralph/agents.md` | Operational guide (~50 lines) | Project lifetime |
| `.ralph/guardrails.md` | Signs (accumulated error lessons) | Current execution |
| `.ralph/failures.json` | Per-teammate failure tracking | Current execution |
| `.ralph/metrics.json` | Task success/failure counts | Current execution |
| `.ralph/specs/{goal}/discovery.md` | Problem definition, constraints | Current goal |
| `.ralph/specs/{goal}/design/detailed-design.md` | Architectural decisions | Current goal |
| `.ralph/specs/{goal}/implementation/plan.md` | Prioritized tasks | Current goal |
| `*.code-task.md` | Individual task descriptions + status | Current goal |

---

## Memories System (guardrails.md)

**Constraints:**
- You MUST add memories when errors occur because this prevents repeat failures
- You MUST read .ralph/guardrails.md at task start because accumulated knowledge guides behavior
- You MUST use flock for writes because multiple teammates access concurrently

When errors occur, add to .ralph/guardrails.md (in appropriate section: Fixes, Decisions, or Patterns):

```markdown
### fix-{timestamp}-{hex}
> [What failed and how to fix it]
<!-- tags: testing, build | created: YYYY-MM-DD -->
```

**Concurrent access**: Multiple teammates read .ralph/guardrails.md at task start. Writes use `flock` to prevent corruption. Each completed task potentially adds lessons that benefit all subsequent tasks across all teammates — this is compounding intelligence.

---

## Failure Tracking (.ralph/failures.json)

Per-teammate consecutive failure counter, written by the TaskCompleted hook.

**Format:**
```json
{
  "teammate-1-uuid": {
    "consecutive_failures": 2,
    "last_failure": "Gate 'test' failed: 3 tests failing",
    "total_failures": 5,
    "total_successes": 8
  },
  "teammate-2-uuid": {
    "consecutive_failures": 0,
    "last_failure": null,
    "total_failures": 1,
    "total_successes": 12
  }
}
```

**Behavior:**
- TaskCompleted hook increments `consecutive_failures` on gate failure, resets to 0 on success
- TeammateIdle hook reads this file — if `consecutive_failures >= MAX_CONSECUTIVE_FAILURES`, exits 0 (circuit breaker)
- Lead monitors via `Read(".ralph/failures.json")` during Phase 2

---

## Metrics Tracking (.ralph/metrics.json)

Aggregate success/failure counts, written by the TaskCompleted hook.

**Format:**
```json
{
  "tasks_completed": 8,
  "tasks_failed": 2,
  "tasks_pending": 5,
  "gates_passed": 8,
  "gates_failed": 3,
  "last_updated": "2026-02-10T14:30:00Z"
}
```

**Behavior:**
- Updated on every TaskCompleted hook invocation
- Lead reads during Phase 2 monitoring for progress reporting
- Used in completion summary: "N tasks completadas. {metrics summary}."

---

## Task Files (*.code-task.md)

Individual task descriptions generated by sop-task-generator (Step 4).

**Status lifecycle:**
```
PENDING → IN_PROGRESS → COMPLETED
                      → BLOCKED (documented in blockers.md, teammate moves to next)
```

**Status header** (added by teammates during execution):
```markdown
---
Status: COMPLETED
Completed-By: teammate-1
Completed-At: 2026-02-10T14:30:00Z
---
```

**Blocked-By field**: Tasks can declare dependencies on other tasks. The lead uses `TaskUpdate(addBlockedBy=[...])` to enforce ordering in Agent Teams.

---

## File Lifecycle Table

| Phase | .ralph/guardrails.md | failures.json | metrics.json | .code-task.md | .ralph/agents.md |
|-------|--------------|---------------|--------------|---------------|-----------|
| Planning (Steps 0-6) | Created if missing | — | — | Generated (Step 4) | Generated (Step 5) |
| Launch (Step 8) | Read by teammates | Initialized empty | Initialized empty | TaskCreate per file | Read by teammates |
| Execution | Append (flock) | Updated per task | Updated per task | Status updated | Read-only |
| Completion | Preserved | Preserved | Preserved | All COMPLETED | Preserved |

---

## Troubleshooting

### State File Corruption

If state files become inconsistent:
- You SHOULD check git history for last valid state
- You MUST NOT continue execution with corrupted state
- You SHOULD reset `.ralph/failures.json` if circuit breaker is stuck

### Signs Ignored by Teammates

If same errors repeat despite Signs in .ralph/guardrails.md:
- You SHOULD verify Sign format includes Trigger and Instruction
- You SHOULD use `SendMessage` to remind specific teammate to re-read .ralph/guardrails.md
- You MUST review Sign clarity (vague instructions are ignored)

### Concurrent Write Conflicts

If .ralph/guardrails.md shows corruption:
- You SHOULD verify flock is being used for writes
- You SHOULD check for teammates writing without proper locking
- You MUST restart affected teammates after fixing the file

---

*Version: 2.0.0 | Updated: 2026-02-10*
*Agent Teams state model*
