# AI Framework Architecture

**Internal architecture documentation for maintainers and AI.**

> This doc explains HOW the framework works internally. For user docs, see [README.md](../README.md).

---

## Table of Contents

1. [Overview](#overview)
2. [Directory Structure](#directory-structure)
3. [Core Components](#core-components)
4. [Session Lifecycle](#session-lifecycle)
5. [Integration Patterns](#integration-patterns)
6. [Extension Guide](#extension-guide)
7. [Troubleshooting](#troubleshooting)

---

## Overview

**AI Framework** = Claude Code Plugin + Constitutional Governance

Three pillars:

1. **Hooks** — Auto-execute on Claude events (SessionStart, PreToolUse, etc.)
2. **Commands** — Slash commands (`/utils:project-init`, `/commit`, etc.)
3. **Agents** — Specialized sub-agents for specific tasks (45 total)

**Key Insight**: Framework uses hooks to **enforce** governance, not just suggest.

---

## Directory Structure

```
ai-framework/
├── .claude-plugin/              # Plugin source (Claude Code reads this)
│   ├── plugin.json              # Manifest (version, author, description)
│   ├── marketplace.json         # Marketplace metadata
│   ├── hooks/                   # Auto-executing scripts
│   │   ├── hooks.json           # Hook registration
│   │   ├── session-start.py     # Framework installer
│   │   ├── workspace-status.py  # Session guide
│   │   ├── pre-tool-use.py      # Context injection for sub-agents
│   │   ├── security_guard.py    # Security vulnerability checks
│   │   ├── clean_code.py        # Auto-formatter
│   │   ├── minimal_thinking.py  # Thought process optimizer
│   │   └── ccnotify.py          # macOS desktop notifications
│   ├── commands/                # Slash commands (24 total)
│   │   ├── PRD-cycle/           # prd-sync, prd-new
│   │   ├── SDD-cycle/           # specify, plan, tasks, implement, clarify, analyze, constitution
│   │   ├── git-github/          # commit, pr, issue-manager, issue-sync, worktree/
│   │   └── utils/               # project-init, understand, docs, polish, setup-dependencies, etc.
│   ├── agents/                  # Sub-agents (45 total, 11 categories)
│   │   ├── Architecture & System Design/
│   │   ├── Code Review & Security/
│   │   ├── Database Management/
│   │   └── ...
│   └── template/                # Files copied to user projects
│       ├── CLAUDE.md            # Project config (references docs)
│       ├── .mcp.json            # MCP servers config
│       ├── .gitignore           # Framework file exclusions
│       ├── .claude/
│       │   ├── settings.local.json
│       │   └── rules/           # always-works.md, effective-agents-guide.md, etc.
│       └── .specify/
│           ├── memory/          # constitution.md, design-principles.md, etc.
│           └── templates/       # Workflow templates
├── docs/                        # Internal technical documentation
│   └── architecture.md          # ← You are here
├── README.md                    # User-facing documentation
├── CHANGELOG.md                 # Version history
└── LICENSE                      # MIT

User Project (after installation):
your-project/
├── CLAUDE.md                    # Copied from template/
├── .mcp.json                    # Copied from template/
├── .gitignore                   # Merged with template/.gitignore
├── .claude/                     # Copied from template/.claude/
│   ├── settings.local.json
│   └── rules/
└── .specify/                    # Copied from template/.specify/
    ├── memory/
    │   ├── constitution.md
    │   └── project-context.md   # Generated by /utils:project-init
    └── templates/
```

---

## Core Components

### 1. Hooks (Auto-Execution)

**File**: `.claude-plugin/hooks/hooks.json`

Registers Python scripts to execute on Claude events:

```json
{
  "SessionStart": [
    {
      "hooks": [
        { "type": "command", "command": "session-start.py", "timeout": 10 },
        { "type": "command", "command": "workspace-status.py", "timeout": 5 }
      ]
    }
  ],
  "PreToolUse": [
    {
      "matcher": "Task",
      "hooks": [
        { "type": "command", "command": "pre-tool-use.py", "timeout": 5 }
      ]
    },
    {
      "matcher": "Edit|Write|MultiEdit",
      "hooks": [
        { "type": "command", "command": "security_guard.py", "timeout": 5 }
      ]
    }
  ],
  "PostToolUse": [
    {
      "matcher": "(Edit|Write|MultiEdit)",
      "hooks": [
        { "type": "command", "command": "clean_code.py", "timeout": 15 }
      ]
    }
  ],
  "UserPromptSubmit": [
    {
      "matcher": ".*",
      "hooks": [
        { "type": "command", "command": "minimal_thinking.py", "timeout": 2 },
        {
          "type": "command",
          "command": "ccnotify.py UserPromptSubmit",
          "timeout": 2
        }
      ]
    }
  ],
  "Stop": [
    {
      "matcher": ".*",
      "hooks": [
        { "type": "command", "command": "ccnotify.py Stop", "timeout": 2 }
      ]
    }
  ],
  "Notification": [
    {
      "matcher": ".*",
      "hooks": [
        {
          "type": "command",
          "command": "ccnotify.py Notification",
          "timeout": 2
        }
      ]
    }
  ]
}
```

**Hook purposes**:

| Hook                  | Trigger          | Purpose                                            | Critical? |
| --------------------- | ---------------- | -------------------------------------------------- | --------- |
| `session-start.py`    | SessionStart     | Auto-installs framework files on first run         | ✅ Yes    |
| `workspace-status.py` | SessionStart     | Shows session guidance (worktree, project-context) | No        |
| `pre-tool-use.py`     | PreToolUse(Task) | Injects always-works.md into Task tool invocations | No        |
| `security_guard.py`   | PreToolUse(Edit) | Blocks security vulnerabilities before Write       | ✅ Yes    |
| `clean_code.py`       | PostToolUse      | Auto-formats Python files after Edit/Write         | No        |
| `minimal_thinking.py` | UserPromptSubmit | Optimizes Claude thought process budget            | No        |
| `ccnotify.py`         | Multiple events  | macOS desktop notifications for task completion    | No        |

### 2. Commands (Slash Commands)

**Directory**: `.claude-plugin/commands/`

Markdown files with frontmatter:

```markdown
---
description: Brief description
argument-hint: "optional args"
allowed-tools: Read, Glob, Grep, Write
---

# Command Name

Implementation instructions for Claude to follow.
```

**Command categories**:

- **PRD-cycle** (2): `/prd-sync`, `/prd-new`
- **SDD-cycle** (7): `/specify`, `/plan`, `/tasks`, `/implement`, `/clarify`, `/analyze`, `/constitution`
- **git-github** (6): `/commit`, `/pr`, `/issue-manager`, `/issue-sync`, `/worktree:create`, `/worktree:cleanup`
- **utils** (9): `/project-init`, `/understand`, `/docs`, `/polish`, `/setup-dependencies`, `/changelog`, `/deep-research`, `/three-experts`, `/session-start`

**Total**: 24 commands

### 3. Agents (Sub-Agents)

**Directory**: `.claude-plugin/agents/`

Specialized agents invoked via Task tool:

```markdown
---
name: python-pro
description: Master Python 3.12+ with modern features...
model: sonnet
---

You are a Python expert specializing in...
```

**Agent registry** (45 total):

- Architecture & System Design (8)
- Code Review & Security (5)
- Database Management (2)
- DevOps & Deployment (4)
- Documentation & Technical Writing (5)
- Incident Response & Network (2)
- Performance & Observability (3)
- Shadcn-UI Components (4)
- Testing & Debugging (4)
- User Experience & Design (3)
- Web & Application (5)

### 4. Templates (Installation Files)

**Directory**: `.claude-plugin/template/`

Files copied to user project on first session:

- **CLAUDE.md**: Project configuration (references governance docs)
- **.mcp.json**: MCP servers configuration
- **.claude/settings.local.json**: User-specific settings
- **.claude/rules/**: Governance files (always-works.md, effective-agents-guide.md, etc.)
- **.specify/memory/**: Constitutional documents (constitution.md, design-principles.md, etc.)

---

## Session Lifecycle

### Complete Flow (Claude Startup → Ready)

```
User runs: claude
       ↓
═══════════════════════════════════════════════════════════
HOOK 1: session-start.py (INSTALLER)
═══════════════════════════════════════════════════════════
       ↓
Check: Is framework installed?
  (verifies CLAUDE.md, constitution.md, settings.local.json exist)
       ↓
       ├─ YES (already installed)
       │  ├─ Check: .gitignore up to date?
       │  │  ├─ YES → Silent exit (nothing to do)
       │  │  └─ NO → Update .gitignore → "No necesitas reiniciar"
       │  └─ Exit
       │
       └─ NO (first installation)
          ├─ Copy template/ files to project root
          │  • CLAUDE.md
          │  • .mcp.json
          │  • .claude/ (settings.local.json, rules/)
          │  • .specify/ (memory/, templates/)
          │  • Merge .gitignore
          │
          ├─ Create marker: .claude/.pending_restart
          │  (signal to workspace-status: "don't execute this session")
          │
          ├─ Check missing dependencies
          │  (terminal-notifier, black, etc.)
          │
          └─ Show message:
             "✅ AI Framework instalado
              🔄 Reinicia Claude Code ahora"
       ↓
User restarts Claude Code
       ↓
═══════════════════════════════════════════════════════════
HOOK 2: workspace-status.py (SESSION GUIDE)
═══════════════════════════════════════════════════════════
       ↓
Check: .claude/.pending_restart exists?
       ↓
       ├─ YES → Delete marker, silent exit
       │       (avoid duplicate messages with session-start)
       │
       └─ NO → Show session guidance
               ↓
               Check: .specify/memory/project-context.md exists?
               ↓
               ├─ YES → "📋 Project Context: Configurado"
               │        "💡 Mantén actualizado: /utils:project-init"
               │
               └─ NO → "📋 Project Context: No configurado"
                       "⚡ Configúralo ahora: /utils:project-init"
               ↓
               + Show worktree status
               + Show session objective guidance
               + Remind git sync (git status, git pull)
               + Security warning (if bypassPermissions active)
       ↓
Claude ready for user interaction
```

### Key Integration: Marker Coordination

**session-start.py** creates marker after installation:

```python
# After copying files
(project_dir / ".claude" / ".pending_restart").touch()
```

**workspace-status.py** checks for marker:

```python
marker = project_dir / ".claude" / ".pending_restart"
if marker.exists():
    marker.unlink()  # Delete marker
    sys.exit(0)      # Silent exit
```

**Why**: Prevents showing both messages simultaneously:

- session-start: "Reinicia Claude"
- workspace-status: "Project context no configurado"

If marker exists = session-start just spoke, workspace-status stays silent.

---

## Integration Patterns

### 1. Hook → Hook Coordination

**Pattern**: Marker files for sequencing

```
session-start.py (first)  →  .pending_restart marker  →  workspace-status.py (second)
       ↓                              ↓                            ↓
   Installs files                  Signal                   Checks marker
                                "I just ran"                  ↓
                                                        Marker exists?
                                                        YES → Skip
                                                        NO → Execute
```

### 2. Hook → Command Integration

**Pattern**: Hook suggests command, user executes

```
workspace-status.py                 User                /utils:project-init
       ↓                             ↓                          ↓
Shows: "No configurado"       Executes command          Runs AI analysis
       ↓                             ↓                          ↓
"⚡ /utils:project-init"      /utils:project-init      Generates project-context.md
```

### 3. Command → File → CLAUDE.md Auto-Load

**Pattern**: Generated files auto-loaded by Claude via @ references

```
/utils:project-init command
       ↓
Analyzes codebase (understand.md phases)
       ↓
Generates: .specify/memory/project-context.md
       ↓
CLAUDE.md references: @.specify/memory/project-context.md
       ↓
Claude auto-loads on every session (via @ reference)
       ↓
Claude knows: tech stack, patterns, recommended agents
```

### 4. Hook → Sub-Agent Context Injection

**Pattern**: pre-tool-use.py injects governance into Task tool

```
User invokes Task tool (sub-agent)
       ↓
PreToolUse hook triggers: pre-tool-use.py
       ↓
Reads: .claude/rules/always-works.md
       ↓
Injects content into sub-agent context
       ↓
Sub-agent receives governance rules automatically
```

---

## Extension Guide

### Adding a New Hook

**Step 1**: Create Python script in `.claude-plugin/hooks/`

```python
#!/usr/bin/env python3
import sys
import json

def main():
    try:
        # Hook logic here
        output = {"systemMessage": "Hook executed"}
        print(json.dumps(output, indent=2))
        sys.exit(0)
    except Exception:
        sys.exit(0)  # Silent fail - never block Claude

if __name__ == "__main__":
    main()
```

**Step 2**: Register in `hooks.json`

**Step 3**: Test with `python3 hooks/my-hook.py`

### Adding a New Command

**Step 1**: Create `.claude-plugin/commands/category/my-command.md`

```markdown
---
description: What this command does
allowed-tools: Read, Glob, Grep, Write
---

# My Command

Step-by-step instructions for Claude.
```

**Step 2**: Test with `/my-command` in Claude

### Adding a New Agent

**Step 1**: Create `.claude-plugin/agents/Category/my-agent.md`

```markdown
---
name: my-agent
description: What this agent does
model: sonnet
---

You are a specialist in...
```

**Step 2**: Invoke via Task tool

### Adding Template Files

**Step 1**: Add file to `.claude-plugin/template/`

**Step 2**: Reference in `template/CLAUDE.md` if needed

**Step 3**: session-start.py auto-copies on next installation

---

## Troubleshooting

### Common Issues

| Issue                         | Cause               | Solution                                   |
| ----------------------------- | ------------------- | ------------------------------------------ |
| **Hooks not executing**       | Python not in PATH  | Install Python 3.8+                        |
| **session-start loops**       | Marker not deleted  | Delete `.claude/.pending_restart` manually |
| **Commands not showing**      | Cache stale         | Restart Claude or `/help`                  |
| **Agent not in Task list**    | Invalid frontmatter | Check `name:` and `description:` fields    |
| **Template files not copied** | Already installed   | Delete CLAUDE.md and restart Claude        |
| **project-context stale**     | Project evolved     | Run `/utils:project-init` to regenerate    |

### Validation Checklist

Before committing changes:

- [ ] Python syntax valid: `python3 -m py_compile file.py`
- [ ] Hooks registered in `hooks.json`
- [ ] Commands have valid frontmatter
- [ ] Agents have `name` and `description`
- [ ] No hardcoded paths (use Path or env vars)
- [ ] Silent failures (hooks never block Claude startup)

---

## Architecture Decisions

### Why Python for Hooks?

- ✅ Cross-platform (Windows, macOS, Linux)
- ✅ Rich stdlib (Path, json, shutil)
- ✅ Claude Code native support
- ✅ Easy text processing

### Why Markdown for Commands/Agents?

- ✅ Human-readable
- ✅ Claude-native format
- ✅ Supports frontmatter (metadata)
- ✅ Easy to version control

### Why Separate session-start + workspace-status?

- ✅ **Single Responsibility**: session-start = installer, workspace-status = guide
- ✅ **Performance**: workspace-status skips on first run (marker coordination)
- ✅ **Maintainability**: Focused hooks easier to debug than monolithic script

### Why No Auto-Generation in workspace-status?

- ✅ **AI-First Principle**: Claude AI > Python script for analysis
- ✅ **Quality**: AI command generates comprehensive context vs basic detection
- ✅ **Simplicity**: Eliminated Python tech detection (delegate to AI command)

---

## Version History

See [CHANGELOG.md](../CHANGELOG.md) for detailed version history.

---

## Maintenance Notes

### When to Update Template Files

Template files are copied on first installation only. To update existing installations:

1. User must manually update OR
2. User must delete CLAUDE.md and restart (triggers reinstall)

**Best practice**: Make templates backward-compatible.

### When to Add New Hooks

Only add hooks if:

- ✅ Prevents common user errors (security_guard)
- ✅ Saves repetitive manual work (clean_code)
- ✅ Essential for framework function (session-start)

❌ Don't add hooks for:

- Nice-to-have features
- Can be done with commands
- Slows down Claude startup

### When to Add New Commands

Commands are cheap (just markdown files). Add liberally if:

- ✅ Implements common workflow
- ✅ Reuses understand.md or other commands
- ✅ AI can execute autonomously

### When to Add New Agents

Agents are cheap but add cognitive load. Add only if:

- ✅ Solves specific domain problem
- ✅ Not covered by existing agents
- ✅ Will be used frequently

---

**Maintainer**: Dario Arcos
**License**: MIT
